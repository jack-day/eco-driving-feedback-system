# Eco-driving Device Software

## Warning
The device software is designed to be run on a Raspberry Pi 4 Model B with an
Adafruit 128x64 OLED Bonnet. Running the software in a different environment
will not work. However, testing and some other operations can be completed
outside of this RPi environment. For this reason, setup for the OLED bonnet has
been kept separate and can be found in [adafruit/](adafruit).


## Dependencies
Required dependencies that must be installed for the device to run. Other
dependency versions may be compatible but only those listed have been tested 
and are known to work.

- Python3.8
- PostgreSQL v14
- TimescaleDB v2.6.0 (Optional)

For instructions on installing TimescaleDB, view [doc/installing_timescaledb.md](doc/installing_timescaledb.md).

To install the remaining dependencies, run:
```
pip install -r requirements.txt
```

To install development dependencies, including the dependencies required
to run tests, run:
```
pip install -r requirements_dev.txt
```


## Setup
### Database
The device's database must first be created and initialised. To initialise the
database once created, run:
```
psql [dbname] -f db/init.sql
```
Or alternatively run:
```
psql [dbname] < db/init.sql
```

When testing, a separate testing database should be created and initialised
using the same steps.

If you wish to not use TimescaleDB, remove or comment-out lines 1, 35, and 36
in `db/init.sql` to prevent errors during setup. This should not effect
functionality but will effect performance.


### Device Settings and Simulated GPS Data
A `settings.yaml` file and a `gps.yaml` file must be created to store the
device's settings and the simulated GPS data to be given to the device. Examples
for these files can be found in [settings_example.yaml](settings_example.yaml)
and [gps_example.yaml](gps_example.yaml).

Testing versions of these files are already created and can be found in
[tests/test_data/](tests/test_data/). These files are depended upon by the tests
and altering them may cause the tests to fail.


### Config
Finally a `config.ini` file must be created. This can be done by using
[config_default.ini](config_default.ini) as a template, replacing any values as
necessary. When running the device most settings will need to be changed,
however for testing you should only need to change the database settings, which
are prefixed by 'db'.


## Usage
To run the device, run:
```
python device/main.py
```


## Testing
Before running tests, ensure the `DEVICE_ENV` environment variable is set to
`testing`. In Windows Command Prompt, this can be done using:
```
set DEVICE_ENV=testing
```

In Linux, this can be done using:
```
export DEVICE_ENV=testing
```

Tests can then be run using:
```
pytest
```

### Coverage
Test coverage can be collected by running:
```
coverage run -m pytest
```

A coverage report can then be subsequently generated by running:
```
coverage report -m --omit="tests/*"
```

The Device CI action generates a coverage report that can be found at
[doc/coverage.md](doc/coverage.md).


## Code Documentation
Code documentation can be found in [doc/html/](doc/html/).
